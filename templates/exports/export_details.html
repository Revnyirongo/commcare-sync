{% extends "web/app/app_base.html" %}
{% load static %}
{% load dateformat_tags %}
{% block app %}
<section class="section app-card">
  <div class="level">
    <!-- Left side -->
    <div class="level-left">
      <h1 class="title">{{ export.name }} - Details</h1>
    </div>
    <div class="level-right">
      <a class="button is-primary is-rounded is-small is-outlined" href="{% url 'exports:edit_export_config' export.id %}">
        <span class="icon">
          <i class="fa fa-edit"></i>
        </span>
        <span>Edit Details</span>
      </a>
    </div>
  </div>
  <a class="button is-primary is-rounded is-small" href="{{ export.config_file.url }}">
    <span class="icon">
      <i class="fa fa-download"></i>
    </span>
    <span>Download Config File</span>
  </a>
</section>
<section class="section app-card">
  <h1 class="title">Run History</h1>
  <button class="button is-primary is-rounded is-small" id="run-export-button">
    <span class="icon">
      <i class="fa fa-play"></i>
    </span>
    <span>Run Now</span>
  </button>
  <div class="progress-bar-demo my-2" >
    <div class='progress-wrapper'>
      <div id="progress-bar" class='progress-bar'>&nbsp;</div>
    </div>
    <div id="progress-bar-message" style="color: grey;">Waiting for progress to start...</div>
  </div>
  <table class="table is-striped is-fullwidth my-2">
    <thead>
    <tr>
      <th>Run Start</th>
      <th>Duration</th>
      <th>Status</th>
      <th>Log</th>
    </tr>
    </thead>
    <tbody>
    {% for export_run in runs %}
      <tr>
        <td>{{ export_run.created_at }}</td>
        <td>{{ export_run.duration|readable_timedelta }}</td>
        <td>{{ export_run.status }}</td>
        <td>
          <a class="log-trigger" data-open-status="closed" data-export-run-id="{{ export_run.id }}"><span class="icon"><i class="fa fa-chevron-down"></i></span>
            View log
          </a>
        </td>
      </tr>
      <tr class="export-log my-1" id='export-log-{{ export_run.id }}' style="display: none;" >
        <td colspan="4">
          {{ export_run.get_log_html }}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</section>
{% endblock app %}
{% block page_js %}
    <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
    <script src="{% static 'js/App-bundle.js' %}"></script>
    <script>
    var apiUrl = "{% url 'exports:run_export' export.id %}";
    var progressUrl = "{% url 'celery_progress:task_status' 'task-id-stub' %}";
    const Cookies = SiteJS.App.Cookies;

    document.addEventListener("DOMContentLoaded", function () {
        var trigger = document.getElementById('run-export-button');
        trigger.addEventListener('click', function (e) {
            e.preventDefault();
            var pb = document.getElementById('progress-bar');
            pb.style.display = 'inherit';
            fetch(apiUrl, {
                method: 'post',
                credentials: 'same-origin',
                headers: {
                  'X-CSRFToken': Cookies.get('csrftoken'),
                }
            }).then(
                function (response) {
                    return response.text();
                }).then(function (text) {
                    var taskUrl = progressUrl.replace('task-id-stub', text);
                    CeleryProgressBar.initProgressBar(taskUrl, {
                      onProgress: function (progressBarElement, progressBarMessageElement, progress) {
                          progressBarElement.style.width = progress.percent + "%";
                          progressBarElement.style.backgroundColor = '#3273dc';
                          progressBarMessageElement.innerHTML = progress.current + ' of ' + progress.total + ' processed.';
                      },
                      onResult: function (resultElement, result) {
                          console.log(result);

                      }
                    });
                  })
                  .catch(function (error) {
                    console.error('Request failed', error);
                });
                e.preventDefault();
        }, false);
    });
    </script>
  <script type="application/javascript">
  document.addEventListener('DOMContentLoaded', () => {
      let releaseNotesTriggers = document.getElementsByClassName('log-trigger');
      for (let i = 0; i < releaseNotesTriggers.length; i++) {
          releaseNotesTriggers[i].addEventListener("click", function (event) {
              let trigger = event.target.closest('a');
              let selectorId = 'export-log-' + trigger.dataset.exportRunId;
              let notes = document.getElementById(selectorId);
              let icon = trigger.querySelector(".fa");
              if (trigger.dataset.openStatus === 'closed') {
                  notes.style.display = '';
                  trigger.dataset.openStatus = 'open';
                  icon.classList.remove('fa-chevron-down');
                  icon.classList.add('fa-chevron-up');
              } else {
                  notes.style.display = 'none';
                  trigger.dataset.openStatus = 'closed';
                  icon.classList.remove('fa-chevron-up');
                  icon.classList.add('fa-chevron-down');
              }
          });
      }
  });
</script>

{% endblock %}
